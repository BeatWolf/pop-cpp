
\section{Requirements for Virtual POP-C++}
\label{weakness}
This chapter aims to identify the weaknesses and the missing elements of VPOP1. At the end of this chapter, all the modifications that have to be brought for the final version to be produced for the ViSaG project will be summarized and shared between the EIA-FR and the HEPIA.\s


\subsection{Hypervisor related data}
In VPOP1, all the data related to the hypervisor connection are saved as environment variables. These data should be saved in the JobMgr config file located at \textit{POPC\_LOCATION}/etc/jobmgr.conf. The hypervisor password should be encrypted and not saved in clear.\s

\textbf{Files to be modified :} ./lib/jobmgr.cc, ./include/jobmgr.ph, ./script/popc\_setup.in\s

\textbf{Work done:}\\
All the hypervisor related data are now stored in a file located in the POP\_LOCATION/etc/virtual.conf. These data could evolve with the changes that will be done in the future. \s

\textbf{Decision:}\\
The password is not encrypted yet. This point is still open at the moment (a discussion with security expert must be held to find the best practice to put in place).

\subsection{Code injection in wrapper}
In the wrapper used to contact the hypervisor, some methods execute a shell command. As the command executed is prepared in the method, some malicious codes could be injected. To avoid this code injection, the commands should be controlled before their execution.\s

\textbf{Files to be modified : } ./lib/ESXWrapper.cc\s

\textbf{Work done:}\\
Nothing for the moment.\s

\textbf{Decision:}\\
The methods using shell command will be replaced by VIX API code. The cloning process could run some external shell command but it is not well defined for the moment.

\subsection{POP Application Identifier}
A POP Application Identifier must be created for any POP-C++ application. This ID must be sent with the resource discovery request. A virtual node will create only one virtual machine (VM) per application. Any parallel object of the same application running on the same virtual node will be executed in the same VM. This VM will be shutdown at the end of the application or after a specified idle time.\s

\textbf{File to be modified : } ./lib/request.cc, ./include/request.h, ./lib/jobmgr.cc, ./lib/appservice.ph, ./lib/ap- pservice.cc, ./lib/popc\_search\_node.cc\s

\textbf{Work done:}\\
The POPAppId is passed in the resource discovery process and the admin-VM takes it into consideration for the workers management. The VM is shutdown when it has no more jobs running on it. This step is finished.\s

\textbf{Decision:}\\
The VM could be shutdown when the application is finished. A message must be send to all nodes to shutdown the VM associated with the application.

\subsection{Installation of admin and worker VM}
The installation of the environment on the admin and worker VM could be the source of many problems. This installation should be as automatic as possible (missing library, ssh key generation, ssh\_config, cloning VM ...).\s

\textbf{Files to be modified : } ./script/popc\_setup.in, ./configure.ac\s

\textbf{Work done:}\\
The configure script is no able to accept the option "--enable-virtual". This option allows the user to compile POP-C++ in the Virtual version. Without this option, the standard version is compiled. To be able to compile two different versions, a VirtualJobMgr and a VirtualPOPCSearchNode have been implemented. All the virtual version is implemented by overwriting basic function of the standard JobMgr and POPCSearchNode. This step is almost done. There is some work to do in the installation script (remove useless questions, check SSH, generate key if not present ...). \s

\textbf{Decision:}\\
Do the small modifications on the popc\_setup script as soon as we have the time. 

\subsection{Cloning VM}
The worker VM must be cloned as much as needed on a virtual node. This process should be done before needing the VM. As the cloning process takes some time, it could be a good idea to start the cloning process when just one VM is available. 

For example, a node running Virtual POP-C++ is using 3 workers. When the second worker is reserved (just one more worker free), the cloning process starts to make a new worker. The maximum number of worker on a node must be defined during the installation.\s

\textbf{Files to be modified: } Not defined \s

\textbf{Work done:}\\
Some experiments with VIX and with a home made script. Nothing implemented in POP-C++ for the moment. HEPIA has maybe some hints to give about this process. \s

\textbf{Decision:}\\
Using the hard copy solution from a C++ code. Asking HEPIA if they could find a better solution. The cloning process starts when there are only X free VM left. The number of VM prepared in advance is specified as an option.

\subsection{Preparation of the worker VM}
In the current version, the preparation of the VM is not very reliable. In fact, during this preparation, the ESXWrapper will try to get the VM IP. After three attempts, the preparation will fail if the IP is not discovered. This process should be optimized and maybe done differently.\s

\textbf{Files to be modified : } ./lib/ESXWrapper.cc\s

\textbf{Work done:}\\
Solved the waiting problem. Try with the VIX API, which seems to be more reliable than the command line tool. Nothing is implemented with the VIX API in POP-C++ for the moment but I got a test program sample. \s

\textbf{Decision}\\
Using the VIX API to retrieve the IP address. DHCP renewal must be done before retrieving the address (this point is open because more information on DHCP must be found).

\subsection{JobMgr - Management of VM and jobs}
As the JobMgr running on the admin-VM must be able to manage several worker-VM, this JobMgr must be modified to include the management of different VM with the POPAppID. This management must include the startup, check during runtime and shutdown of a VM for an application.\s

\textbf{Files to be modified : } ./lib/jobmgr.cc, ./lib/ESXWrapper.cc\s

\textbf{Work done:}\\
Modify the check and reserve process for taking into consideration the management of several workers. Ability to run several objects of the same application on the same VM. Host resource management must be defined. \s

\textbf{Decision:}\\
The admin-VM manage all the resource on the node. The all node is seen as one POP-C++ node. The VMs are just a way to encapsulate the parallel objects execution.

\subsection{WorkerDeamon}
The WorkerDeamon is in charge of the key exchange between the admin-VM and the worker-VM. This worker is not well developed. Here are some hints to find a different way to exchange the keys:\s

\textbf{Hints:} 
\begin{itemize}
\item The keys could be passed during the installation of the environment. Once one worker-VM is cloned, its virtual disk could be mounted on the admin-VM and the admin-VM key could be write in the file system.
\item The keys could be passed during the installation of the environment. Once one worker-VM is cloned, it could be started and the keys exchanged before taking a snapshot of it. 
\item A POP-C++ parallel object could be used to do that. The creation of a virtual POP-C++ service as a parallel object could run independently on the worker-VM. This parallel object could be contacted by the admin-VM and the keys could be exchanged.
\end{itemize}

\textbf{Work done:}\\
Test program with the VIX API and the copy file function. This solution seems to work perfectly. With this solution, the POP-C++ Security Manager running on the admin-VM could manage the keys of all workers. Nothing has to run on the worker. \s

\textbf{Decision:}\\
Use the VIX API to do this task. Ask HEPIA is they could find another way to communicate between the admin-VM and the worker-VM. We are aware that this solution is less generic.\\
Some other solution must be explored such as shared disk or shared network (libvirt).

\subsection{Pseudo-Main}
As we want to run a POP-C++ application in a full secured environment, the main of the application should be launched in a VM too. To do that, a pseudo-main could redirect the real main on a VM and launch it in a secure way.\s

\textbf{Files to be modified} : POP-C++ compiler (paroc\_main)\s

\textbf{Work done:}\\
Nothing for the moment.\s

\textbf{Decision:}\\
This point is open. We can offer an option to let the user choose to run the main in a VM or not.

\subsection{Fusion of POP-C++ 1.3.1 beta JS1.2 and Virtual-POP-C++}
The Virtual version of POP-C++ must be merged with the secure version of the POP-C++. This will make the ViSaG version of POP-C++.\s

\textbf{Work done:}\\
Prepare the configure script to be able to accept the option "--enable-secure". 

\subsection{Minimal Linux distribution}
The admin-VM should be as light as possible. In fact, this admin-VM will never run a parallel object for a POP-C++ application. This VM is only in charge of the management of the others VM known as worker-VM. Due to this fact, this VM should run the lightest distribution of Linux that can run the POP-C++ Global Services. This distribution should also support "libvirt" and the "vSphere CLI" libraries.\s

\textbf{Work done:}\\
Nothing for the moment. HEPIA could work in this. 

\subsection{Add restrictions on SSH}
It's possible to add restrictions on the use of SSH for a specific public key. It could be a good idea to allow only what we really need for POP-C++ (SSH tunnelling and the popcrun command). This restriction are added with the public key in the "authorized\_keys" file. The POP-C++ Security Manager should be able to add these restrictions when it writes a new key. \s

We can imagine that all SSH restrictions are defined during the installation of POP-C++. These information will be passed to the PSM for future usage.\s

\textbf{Work done:}\\
Nothing for the moment.\s

\textbf{Decision:}\\
Add SSH restrictions. Only enable the tunnelling and the use of the "popcobjrun" command.

\subsection{ESXi user and restriction}
VMware ESXi has a user and group management system. It would be more secure to create a specific user for Virtual POP-C++ and allow only the specific action related to its usage. \s

The administrator of the ESXi platform has many privileges that can be granted or revoked. All the actions about users and groups must be done from the vSphere Client. \s

\textbf{Work done:}\\
Nothing for the moment.\s

\textbf{Decision}\\
Using the root account for the moment. When the full version of POP-C++ Virtual and Secure will be ready, ask HEPIA to do some test if we can reduce the rights and use a different account.

\subsection{Testing}
A full protocol of test must be done on the full version of POP-C++ for ViSaG. The tests must contain : 
\begin{enumerate}
\item Stress test to check the concurrency problems.
\item Performance test to be able to measure the overhead and make some optimizations. 
\item Memory test using mudflap or valgrind to check any memory leaks. 
\end{enumerate}

\subsection{Encrypted file system}
The possibility to use an encrypted file system on the VM could enforce the security of the whole project. This point is open and must be studied. 

\pagebreak
\section{Repartition}
This section suggests a repartition of the work between the EIA-FR and the HEPIA (the two schools working on the ViSaG project and more specifically on the lower level of this project).\s

Theoretical, the EIA-FR is in charge of the major modifications of the POP-C++ middle-ware and the HEPIA is in charge of the global VM management. The task above will be 


\begin{center}
\begin{tabular}{|p{1.5cm}|p{7.5cm}|p{2cm}|p{4cm}|}
\hline
\textbf{Section} & \textbf{What ?}	& \textbf{Who ?} & \textbf{Priority} \\ \hline
2.1 & Hypervisor informations & EIA-FR & Medium (Done, except password crypt) \\ \hline

2.2 & Code injections in wrapper & EIA-FR & Medium \\ \hline

2.3 & POP Application Identifier & EIA-FR & (DONE!)\\ \hline

2.4 & Installation of admin and worker VM & EIA-FR & (DONE!) \\ \hline

2.5 & Cloning VM & HEPIA (EIA-FR) & On the way \\ \hline

2.6 & Preparation of worker VM & EIA-FR & (Will be done with VIX) \\ \hline

2.7 & JobMgr - management & EIA-FR & (on the way) \\ \hline

2.8 & WorkerDeamon & EIA-FR & High (VIX API)\\ \hline

2.9 & PseudoMain & EIA-FR & Medium \\ \hline

2.10 & Fusion & EIA-FR & High\\ \hline

2.11 & Minimal Linux distribution & HEPIA & Medium \\ \hline

2.12 & Add restrictions to SSH & EIA-FR & High \\ \hline

2.13 & ESXi user and restrictions & HEPIA & Medium \\ \hline

2.14 & Testing & HEPIA and EIA-FR & High (wait full version) \\ \hline

2.15 & Encrypted file system & HEPIA and EIA-FR & Medium \\ \hline

\end{tabular}
\end{center}\s
